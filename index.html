<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AziPeak Â· Signal-Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=-apple-system,BlinkMacSystemFont,Segoe+UI,Helvetica,Arial,sans-serif&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              gh: {
                canvas: "#f6f8fa",
                border: "#d0d7de",
                muted: "#636c76",
                default: "#1f2328",
                darkCanvas: "#0d1117",
                darkBorder: "#30363d",
                darkMuted: "#8b949e",
                darkDefault: "#c9d1d9",
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial,
          sans-serif;
        -webkit-font-smoothing: antialiased;
        transition:
          background-color 0.2s,
          color 0.2s;
      }
      .mono {
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, monospace;
      }

      .gh-container {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
        background-color: var(--container-bg);
      }

      :root {
        --border-color: #d0d7de;
        --container-bg: #ffffff;
        --header-bg: #f6f8fa;
      }

      .dark {
        --border-color: #30363d;
        --container-bg: #161b22;
        --header-bg: #0d1117;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #d0d7de;
        border-radius: 10px;
      }
      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #484f58;
      }

      /* å‰ 10 åæ¨™è¨»æ¨£å¼ */
      .rank-highlight {
        background-color: #f0f7ff;
      }
      .dark .rank-highlight {
        background-color: rgba(56, 139, 253, 0.15);
      }

      .rank-1 {
        color: #cf222e;
        font-weight: 800;
        border-left: 4px solid #cf222e;
      }
      .rank-2 {
        color: #009a33;
        font-weight: 700;
        border-left: 4px solid #009a33;
      }
      .rank-3 {
        color: #0969da;
        font-weight: 700;
        border-left: 4px solid #0969da;
      }
      .rank-top-10 {
        font-weight: 600;
      }

      /* æµæš¢é€²å ´ */
      .animate-in {
        animation:
          fadeIn 0.4s ease-out,
          slideIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(8px);
        }
        to {
          transform: translateY(0);
        }
      }

      /* é»æ“Šæª”æ¡ˆå€å¼·åŒ– */
      .drop-zone-hover {
        transition: all 0.2s ease;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col dark:bg-gh-darkCanvas bg-white text-gh-default dark:text-gh-darkDefault"
  >
    <!-- Navbar (ä¸è®Š) -->
    <nav
      class="bg-[#24292f] dark:bg-[#010409] text-white py-3 px-4 md:px-8 flex justify-between items-center shrink-0"
    >
      <div class="flex items-center gap-4">
        <svg height="32" viewBox="0 0 16 16" width="32" class="fill-white">
          <path
            d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"
          ></path>
        </svg>
        <div class="flex items-center gap-2 text-sm font-semibold">
          <span class="opacity-70">AziPeak</span>
          <span class="opacity-50">/</span>
          <span class="hover:underline cursor-pointer">Signal-Analyzer</span>
          <span
            class="hidden md:inline-flex items-center ml-2 border border-white/20 px-2 py-0.5 rounded-full text-[10px] opacity-70"
            >Engine v2.0</span
          >
        </div>
      </div>

      <button
        id="themeToggle"
        class="p-2 rounded-md hover:bg-white/10 transition-all flex items-center justify-center"
      >
        <svg
          id="sunIcon"
          class="hidden w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          ></path>
        </svg>
        <svg
          id="moonIcon"
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          ></path>
        </svg>
      </button>
    </nav>

    <main
      class="max-w-7xl mx-auto px-3 sm:px-4 md:px-8 py-4 md:py-8 w-full flex-grow"
    >
      <!-- Upload Section (å¾®èª¿éŸ¿æ‡‰å¼é–“è·) -->
      <div
        id="dropZone"
        class="p-8 sm:p-12 md:p-16 text-center mb-6 md:mb-8 border-2 border-dashed border-gh-border dark:border-gh-darkBorder rounded-lg bg-gh-canvas dark:bg-transparent cursor-pointer hover:border-blue-500 transition-colors group drop-zone-hover"
      >
        <input type="file" id="fileInput" class="hidden" accept=".json" />
        <div class="max-w-sm mx-auto">
          <svg
            viewBox="0 0 24 24"
            width="40"
            height="40"
            class="mx-auto mb-4 fill-gh-muted group-hover:fill-blue-500 transition-colors"
          >
            <path
              d="M3 3a2 2 0 0 1 2-2h9.982a2 2 0 0 1 1.414.586l4.018 4.018A2 2 0 0 1 21 7.022V21a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3zm2 0v18h14V8h-5a2 2 0 0 1-2-2V3H5zm10 0v3h3.022L15 3z"
            ></path>
          </svg>
          <h2 class="text-base sm:text-lg font-semibold mb-1">é–‹å§‹åˆ†æ</h2>
          <p
            class="text-xs sm:text-sm text-gh-muted dark:text-gh-darkMuted mb-6"
          >
            é»æ“Šæˆ–æ‹–æ”¾æ–¹ä½è§’çŸ©é™£æ•¸æ“š (.json)
          </p>
          <button
            class="bg-[#1f883d] hover:bg-[#1a7f37] text-white font-semibold text-xs py-2 px-8 rounded-md shadow-sm"
          >
            é¸æ“‡æœ¬åœ°æª”æ¡ˆ
          </button>
        </div>
      </div>

      <div
        id="resultSection"
        class="hidden space-y-5 md:space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500"
      >
        <!-- Stats Grid Â· æ‰‹æ©Ÿæœ€ä½³åŒ– -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
          <div class="gh-container p-3 md:p-4 shadow-sm">
            <p
              class="text-[9px] md:text-[10px] font-bold text-gh-muted dark:text-gh-darkMuted uppercase mb-1"
            >
              Peak Azimuth
            </p>
            <p
              id="maxAzimuth"
              class="mono text-lg md:text-xl font-bold text-blue-600 dark:text-blue-400 truncate"
            >
              -
            </p>
          </div>
          <div class="gh-container p-3 md:p-4 shadow-sm">
            <p
              class="text-[9px] md:text-[10px] font-bold text-gh-muted dark:text-gh-darkMuted uppercase mb-1"
            >
              Avg Intensity
            </p>
            <p
              id="avgIntensity"
              class="mono text-lg md:text-xl font-bold truncate"
            >
              -
            </p>
          </div>
          <div class="gh-container p-3 md:p-4 shadow-sm">
            <p
              class="text-[9px] md:text-[10px] font-bold text-gh-muted dark:text-gh-darkMuted uppercase mb-1"
            >
              Data Points
            </p>
            <p
              id="totalPoints"
              class="mono text-lg md:text-xl font-bold truncate"
            >
              -
            </p>
          </div>
          <div class="gh-container p-3 md:p-4 shadow-sm">
            <p
              class="text-[9px] md:text-[10px] font-bold text-gh-muted dark:text-gh-darkMuted uppercase mb-1"
            >
              Analysis Build
            </p>
            <p
              class="mono text-lg md:text-xl font-bold text-green-600 dark:text-green-400 truncate"
            >
              v2.0
            </p>
          </div>
        </div>

        <!-- Chart Container Â· ç´…é»/ç´…ç·š/è—é»åœ–å±¤å®Œç¾åˆ†é›¢ -->
        <div class="gh-container p-4 md:p-6 shadow-sm">
          <div
            class="mb-4 border-b border-gh-border dark:border-gh-darkBorder pb-3 flex flex-wrap items-center justify-between"
          >
            <h3
              class="text-sm md:text-base font-semibold flex items-center gap-2"
            >
              <svg
                viewBox="0 0 24 24"
                width="16"
                height="16"
                class="fill-gh-muted dark:fill-gh-darkMuted"
              >
                <path
                  d="M1 1h22v2H1V1zm0 20h22v2H1v-2zm2.5-8L9 7.5 13.5 12l6-6L21 7.5l-7.5 7.5L9 10.5 3.5 16z"
                ></path>
              </svg>
              å¼·åº¦é »è­œ Â· å³°å€¼é€£ç·š
            </h3>
            <span
              class="text-[10px] md:text-xs px-2 py-1 bg-gh-canvas dark:bg-gh-darkCanvas rounded-full text-gh-muted dark:text-gh-darkMuted"
            >
              ğŸŸ¥ ç´…é» Top10 &nbsp; ğŸŸ¦ è—é» å…¶é¤˜æ•¸æ“š
            </span>
          </div>
          <div class="h-[280px] sm:h-[320px] md:h-[360px]">
            <canvas id="intensityChart"></canvas>
          </div>
        </div>

        <!-- Leaderboard (éŸ¿æ‡‰å¼è¡¨æ ¼) -->
        <div class="gh-container shadow-sm">
          <div
            class="px-4 md:px-6 py-3 md:py-4 bg-gh-canvas dark:bg-gh-darkCanvas border-b border-gh-border dark:border-gh-darkBorder"
          >
            <h3
              class="font-semibold text-sm md:text-base flex items-center gap-2"
            >
              <svg
                viewBox="0 0 24 24"
                width="16"
                height="16"
                class="fill-gh-muted dark:fill-gh-darkMuted"
              >
                <path
                  d="M3.5 3.75a.25.25 0 0 1 .25-.25h13.5a.25.25 0 0 1 .25.25v10a.75.75 0 0 0 1.5 0v-10A1.75 1.75 0 0 0 17.25 2H3.75A1.75 1.75 0 0 0 2 3.75v16.5c0 .966.784 1.75 1.75 1.75h7a.75.75 0 0 0 0-1.5h-7a.25.25 0 0 1-.25-.25V3.75z"
                ></path>
                <path
                  d="M13.23 8.97a.75.75 0 0 1 1.06.04l2.5 2.75a.75.75 0 0 1 0 1.08l-2.5 2.75a.75.75 0 1 1-1.1-1.02l1.97-2.16-1.97-2.16a.75.75 0 0 1 .04-1.06z"
                ></path>
              </svg>
              Top 50 è¨Šè™Ÿå¼·åº¦æ’è¡Œ
            </h3>
          </div>
          <div class="overflow-x-auto custom-scrollbar">
            <table class="w-full text-xs md:text-sm">
              <thead
                class="bg-gh-canvas dark:bg-gh-darkCanvas text-[9px] md:text-[10px] font-bold text-gh-muted dark:text-gh-darkMuted uppercase"
              >
                <tr>
                  <th class="px-3 md:px-4 py-2 md:py-3 text-left">æ’å</th>
                  <th class="px-3 md:px-4 py-2 md:py-3 text-left">æ–¹ä½è§’</th>
                  <th class="px-3 md:px-4 py-2 md:py-3 text-right">è¨Šè™Ÿå¼·åº¦</th>
                </tr>
              </thead>
              <tbody id="leaderboardBody" class="text-xs md:text-sm"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer (è¼•é‡) -->
    <footer
      class="mt-6 md:mt-8 py-5 md:py-6 border-t border-gh-border dark:border-gh-darkBorder bg-gh-canvas dark:bg-transparent"
    >
      <div
        class="max-w-7xl mx-auto px-4 md:px-8 text-[10px] md:text-xs text-gh-muted dark:text-gh-darkMuted flex items-center gap-2 justify-center"
      >
        <svg viewBox="0 0 16 16" width="14" height="14" class="opacity-50">
          <path
            fill="currentColor"
            d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"
          ></path>
        </svg>
        <span>Â© 2026 popo Analytics Â· è¨Šè™Ÿåˆ†æå¼•æ“ v2.0</span>
      </div>
    </footer>

    <script>
      // ---------- å…¨åŸŸç‹€æ…‹ ----------
      const themeToggle = document.getElementById("themeToggle");
      const sunIcon = document.getElementById("sunIcon");
      const moonIcon = document.getElementById("moonIcon");
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const resultSection = document.getElementById("resultSection");
      let myChart = null;
      let sortedData = []; // ä¾å¼·åº¦æ’åº
      let currentPoints = []; // ä¾æ–¹ä½è§’æ’åºï¼ˆåŸå§‹æ•¸æ“šï¼‰

      // ---------- ä¸»é¡Œåˆå§‹åŒ– ----------
      const initTheme = () => {
        const isDark =
          localStorage.theme === "dark" ||
          (!("theme" in localStorage) &&
            window.matchMedia("(prefers-color-scheme: dark)").matches);
        if (isDark) {
          document.documentElement.classList.add("dark");
          sunIcon.classList.remove("hidden");
          moonIcon.classList.add("hidden");
        }
      };
      initTheme();

      themeToggle.addEventListener("click", () => {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.theme = isDark ? "dark" : "light";
        sunIcon.classList.toggle("hidden");
        moonIcon.classList.toggle("hidden");

        // é‡æ–°ç¹ªè£½åœ–è¡¨ (ä¿ç•™åœ–å±¤é †åº)
        if (currentPoints.length > 0) {
          const topTen = sortedData.slice(0, 10);
          updateChart(currentPoints, topTen);
        }
      });

      // ---------- æª”æ¡ˆä¸Šå‚³ ----------
      dropZone.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      });

      function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const json = JSON.parse(e.target.result);
            processData(json);
            dropZone.classList.add("hidden");
            resultSection.classList.remove("hidden");
          } catch (err) {
            console.error(err);
            alert("ç„¡æ•ˆçš„ JSON æ ¼å¼ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆã€‚");
          }
        };
        reader.readAsText(file);
      }

      function processData(data) {
        // è½‰æ›ç‚º {x, y} ä¸¦ä¾ç…§æ–¹ä½è§’æ’åºï¼ˆç¢ºä¿æ›²ç·šé€£è²«ï¼‰
        const points = data.map((item) => ({ x: item[0], y: item[1] }));
        points.sort((a, b) => a.x - b.x);
        currentPoints = points;

        // å¼·åº¦æ’åºï¼ˆå‰ååï¼‰
        sortedData = [...points].sort((a, b) => b.y - a.y);
        const topTen = sortedData.slice(0, 10);

        // æ›´æ–°çµ±è¨ˆå¡
        document.getElementById("maxAzimuth").innerText =
          `${topTen[0].x.toFixed(2)}Â°`;
        document.getElementById("avgIntensity").innerText = Math.round(
          points.reduce((a, b) => a + b.y, 0) / points.length,
        ).toLocaleString();
        document.getElementById("totalPoints").innerText = points.length;

        renderLeaderboard(sortedData.slice(0, 50));
        updateChart(points, topTen);
      }

      function renderLeaderboard(data) {
        const tbody = document.getElementById("leaderboardBody");
        tbody.innerHTML = data
          .map((item, i) => {
            const rank = i + 1;
            let rankStyle = "";
            if (rank === 1) rankStyle = "rank-1";
            else if (rank === 2) rankStyle = "rank-2";
            else if (rank === 3) rankStyle = "rank-3";
            else if (rank <= 10) rankStyle = "rank-top-10";

            return `
              <tr class="${rank <= 10 ? "rank-highlight" : ""} hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                <td class="px-3 md:px-4 py-2 md:py-3 font-medium ${rankStyle}">#${rank}</td>
                <td class="px-3 md:px-4 py-2 md:py-3 mono">${item.x.toFixed(2)}Â°</td>
                <td class="px-3 md:px-4 py-2 md:py-3 text-right font-bold mono">${Math.round(item.y).toLocaleString()}</td>
              </tr>
            `;
          })
          .join("");
      }

      // ---------- ğŸš€ å…¨æ–°åœ–è¡¨ç¹ªè£½ Â· å®Œç¾åœ–å±¤æ§åˆ¶ ----------
      // åœ–å±¤é †åº (ç”±ä¸Šè€Œä¸‹) :  ç´…é» (order 4) > ç´…ç·š (order 3) > è—é» (order 2) > è—ç·š (order 1)
      function updateChart(allData, topTen) {
        if (!allData || allData.length === 0) return;

        // é˜²è­·ï¼šè‹¥æœªå‚³å…¥ topTenï¼Œå³æ™‚è¨ˆç®—
        if (!topTen) {
          const sorted = [...allData].sort((a, b) => b.y - a.y);
          topTen = sorted.slice(0, 10);
        }

        const isDark = document.documentElement.classList.contains("dark");
        const textColor = isDark ? "#8b949e" : "#636c76";
        const gridColor = isDark ? "#30363d" : "#f0f0f0";

        // é¡è‰²å®šç¾©
        const blueLineColor = "#0969da";
        const bluePointColor = "#1f6feb";
        const redMainColor = "#cf222e"; // ç´…é» & ç´…ç·š ä¸€è‡´

        // 1. å°‡å‰ååä¾æ–¹ä½è§’æ’åº (ç”¨æ–¼é€£çºŒç¾¤çµ„)
        const topTenSorted = [...topTen].sort((a, b) => a.x - b.x);

        // 2. æ‰¾å‡ºå‰ååä¸­ã€Œåœ¨åŸå§‹æ•¸æ“šä¸­ç´¢å¼•é€£çºŒã€çš„ç¾¤çµ„ (ç´…ç·šé€£ç·šç”¨)
        const consecutiveGroups = [];
        if (topTenSorted.length > 0) {
          let currentGroup = [topTenSorted[0]];
          for (let i = 1; i < topTenSorted.length; i++) {
            const prev = topTenSorted[i - 1];
            const curr = topTenSorted[i];
            const prevIdx = allData.findIndex(
              (d) => d.x === prev.x && d.y === prev.y,
            );
            const currIdx = allData.findIndex(
              (d) => d.x === curr.x && d.y === curr.y,
            );
            if (Math.abs(currIdx - prevIdx) === 1) {
              currentGroup.push(curr);
            } else {
              if (currentGroup.length > 1)
                consecutiveGroups.push([...currentGroup]);
              currentGroup = [curr];
            }
          }
          if (currentGroup.length > 1) consecutiveGroups.push(currentGroup);
        }

        // åˆ¤æ–·æŸé»æ˜¯å¦ç‚ºå‰åå (å¤šæ¬¡ä½¿ç”¨)
        const isTopTenPoint = (point) =>
          topTen.some((t) => t.x === point.x && t.y === point.y);

        // ---------- å»ºæ§‹ datasets (ç”±ä¸‹å±¤å¾€ä¸Šå±¤ push) ----------
        const datasets = [];

        // --- åº•å±¤ 1 : è—è‰²å…‰è­œç·š (ç„¡é», æœ‰åŠé€æ˜å¡«æ»¿) ---
        datasets.push({
          label: "Blue Spectrum Line",
          data: allData,
          borderColor: blueLineColor,
          borderWidth: 2,
          pointRadius: 0,
          fill: true,
          backgroundColor: isDark
            ? "rgba(56, 139, 253, 0.05)"
            : "rgba(9, 105, 218, 0.03)",
          tension: 0.3,
          order: 4, // æœ€ä¸‹å±¤
        });

        // --- åº•å±¤ 2 : è—è‰²æ•¸æ“šé» (éå‰åæ‰é¡¯ç¤ºå°è—é») ---
        datasets.push({
          label: "Blue Points",
          data: allData,
          showLine: false,
          pointBackgroundColor: allData.map((d) =>
            isTopTenPoint(d) ? "transparent" : bluePointColor,
          ),
          pointBorderColor: allData.map((d) =>
            isTopTenPoint(d) ? "transparent" : "#ffffff",
          ),
          pointBorderWidth: 1,
          pointRadius: allData.map((d) => (isTopTenPoint(d) ? 0 : 3)),
          pointHoverRadius: 4,
          order: 3, // ç¬¬äºŒå±¤
        });

        // --- ä¸­å±¤ : ç´…è‰²é€£ç·š (åƒ…é€£æ¥é€£çºŒçš„ Top10 å³°å€¼) Â· é¡è‰²èˆ‡ç´…é»çµ±ä¸€ ---
        consecutiveGroups.forEach((group, idx) => {
          datasets.push({
            label: `Red Connector ${idx + 1}`,
            data: group,
            borderColor: redMainColor, // èˆ‡ç´…é»åŒè‰²
            borderWidth: 3,
            pointRadius: 0,
            fill: false,
            tension: 0.3,
            order: 2, // ç¬¬ä¸‰å±¤
          });
        });

        // --- é ‚å±¤ : ç´…è‰²å³°å€¼é» (å‰åå) Â· é†’ç›®ç™½é‚Š ---
        datasets.push({
          label: "Red Peak Points",
          data: topTen, // ç›´æ¥ä½¿ç”¨å‰åå(æœªæ’åºæ²’é—œä¿‚, åªç•«é»)
          showLine: false,
          pointBackgroundColor: redMainColor,
          pointBorderColor: "#ffffff",
          pointBorderWidth: 2.5,
          pointRadius: 6,
          pointHoverRadius: 8,
          order: 1, // æœ€ä¸Šå±¤
        });

        // ---------- éŠ·æ¯€èˆŠåœ–è¡¨ & å»ºç«‹æ–°åœ– ----------
        const ctx = document.getElementById("intensityChart").getContext("2d");
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
          type: "line",
          data: { datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              x: {
                type: "linear",
                grid: { color: gridColor },
                ticks: {
                  color: textColor,
                  font: { family: "JetBrains Mono", size: 10 },
                },
                title: {
                  display: true,
                  text: "Azimuth (Â°)",
                  color: textColor,
                  font: { weight: "600", size: 11 },
                },
              },
              y: {
                grid: { color: gridColor },
                ticks: {
                  color: textColor,
                  font: { family: "JetBrains Mono", size: 10 },
                },
                title: {
                  display: true,
                  text: "Intensity",
                  color: textColor,
                  font: { weight: "600", size: 11 },
                },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: isDark ? "#161b22" : "#24292f",
                titleColor: "#ffffff",
                bodyColor: "#ffffff",
                borderColor: isDark ? "#30363d" : "#d0d7de",
                borderWidth: 1,
                padding: 10,
                cornerRadius: 6,
                displayColors: false,
                callbacks: {
                  label: function (context) {
                    const point = context.raw;
                    // å¾å…¨åŸŸ sortedData æŸ¥æ‰¾æ’å
                    const rankIdx = sortedData.findIndex(
                      (d) => d.x === point.x && d.y === point.y,
                    );
                    if (rankIdx === -1) {
                      // éå‰åå (è—é»)
                      return [
                        `Azimuth: ${point.x.toFixed(2)}Â°`,
                        `Intensity: ${Math.round(point.y).toLocaleString()}`,
                      ];
                    } else {
                      // å‰åå (ç´…é»)
                      const rank = rankIdx + 1;
                      return [
                        `ğŸ† Rank: #${rank}`,
                        `Azimuth: ${point.x.toFixed(2)}Â°`,
                        `Intensity: ${Math.round(point.y).toLocaleString()}`,
                      ];
                    }
                  },
                },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
